<!-- 
  Wazuh AI SIEM - Local Rules for Noise Reduction
  Location: /var/ossec/etc/rules/local_rules.xml
  
  These rules suppress routine events to reduce alert fatigue
  while keeping important security alerts active.
  
  Author: @Trac3er00
-->

<group name="local,syslog,">

  <!-- ============================================
       PFSENSE NOISE REDUCTION
       ============================================ -->
  
  <!-- Lower single pfSense blocks to level 0 (no alert) -->
  <rule id="110001" level="0">
    <if_group>pfsense</if_group>
    <match>filterlog</match>
    <description>pfSense: Blocked connection (suppressed - single event)</description>
    <group>pfsense,firewall,firewall_block,</group>
  </rule>

  <!-- ============================================
       ADGUARD NOISE REDUCTION  
       ============================================ -->

  <!-- Suppress routine AdGuard blocked queries (level 0 = no alert) -->
  <rule id="111001" level="0">
    <if_sid>111000</if_sid>
    <field name="Result.IsFiltered">true</field>
    <description>AdGuard DNS: Blocked query (suppressed)</description>
    <group>adguard,dns_blocked,</group>
  </rule>

  <!-- Keep malicious blocks at level 5 -->
  <rule id="111002" level="5">
    <if_sid>111000</if_sid>
    <field name="Result.Rules.0.Text">malware|phishing|ransomware</field>
    <description>AdGuard DNS: Blocked MALICIOUS domain $(QH) from $(IP)</description>
    <group>adguard,dns_malicious,</group>
  </rule>

  <!-- ============================================
       PAM/SESSION NOISE REDUCTION
       ============================================ -->

  <!-- Suppress normal PAM session open/close -->
  <rule id="5501" level="0">
    <if_sid>5500</if_sid>
    <match>session opened</match>
    <description>PAM: Session opened (suppressed)</description>
    <group>pam,</group>
  </rule>

  <rule id="5502" level="0">
    <if_sid>5500</if_sid>
    <match>session closed</match>
    <description>PAM: Session closed (suppressed)</description>
    <group>pam,</group>
  </rule>

  <!-- ============================================
       SUDO NOISE REDUCTION
       ============================================ -->

  <!-- Suppress successful sudo from known users (adjust usernames as needed) -->
  <rule id="5403" level="0">
    <if_sid>5400</if_sid>
    <match>COMMAND=</match>
    <user>root|wazuh-user|admin</user>
    <description>Sudo: Command executed (suppressed for trusted user)</description>
    <group>sudo,</group>
  </rule>

  <!-- Keep sudo from unknown users at level 4 -->
  <rule id="5404" level="4">
    <if_sid>5400</if_sid>
    <match>COMMAND=</match>
    <description>Sudo: Command executed by $(srcuser)</description>
    <group>sudo,</group>
  </rule>

  <!-- ============================================
       SSH TUNING
       ============================================ -->

  <!-- Keep single SSH failures low (level 4) -->
  <rule id="5710" level="4">
    <if_sid>5700</if_sid>
    <match>Failed password|invalid user</match>
    <description>sshd: Authentication failure</description>
    <group>sshd,authentication_failed,</group>
  </rule>

  <!-- Brute force stays at level 10 (built-in rule 5712) -->

  <!-- Suppress successful SSH from internal IPs -->
  <rule id="5715" level="0">
    <if_sid>5700</if_sid>
    <match>Accepted</match>
    <srcip>10.10.0.0/23</srcip>
    <description>sshd: Successful login from internal (suppressed)</description>
    <group>sshd,authentication_success,</group>
  </rule>

  <!-- Alert on SSH success from external IPs -->
  <rule id="5716" level="6">
    <if_sid>5700</if_sid>
    <match>Accepted</match>
    <description>sshd: Successful login from external IP $(srcip)</description>
    <group>sshd,authentication_success,</group>
  </rule>

</group>
