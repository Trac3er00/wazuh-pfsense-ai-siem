<!--
  pfSense Custom Decoder for Wazuh
  
  This decoder extracts fields from pfSense filterlog format:
  - Source/Destination IP addresses
  - Source/Destination ports
  - Protocol (TCP/UDP/ICMP)
  - Interface (WAN/LAN)
  - Action (block/pass)
  - Direction (in/out)
  
  Place this file in: /var/ossec/etc/decoders/
  Then restart Wazuh Manager: systemctl restart wazuh-manager
-->

<decoder name="pfsense-filterlog">
  <program_name>filterlog</program_name>
  <prematch>^\d+,</prematch>
</decoder>

<!-- 
  pfSense filterlog CSV format (comma-separated):
  Field positions vary by IP version and protocol
  
  Common fields:
  0: Rule number
  1: Sub-rule number  
  2: Anchor
  3: Tracker
  4: Interface name
  5: Reason (match)
  6: Action (block/pass)
  7: Direction (in/out)
  8: IP version (4/6)
  
  IPv4 TCP/UDP (after field 8):
  9: TOS
  10: ECN
  11: TTL
  12: ID
  13: Offset
  14: Flags
  15: Protocol ID
  16: Protocol name
  17: Length
  18: Source IP
  19: Destination IP
  20: Source Port
  21: Destination Port
  ... (additional TCP flags follow)
-->

<decoder name="pfsense-filterlog-ipv4">
  <parent>pfsense-filterlog</parent>
  <regex type="pcre2">^(\d+),\d*,\d*,\w*,(\w+),\w+,(block|pass),(in|out),4,\w*,\w*,\d+,\d+,\d+,\w*,(\d+),(\w+),\d+,(\d+\.\d+\.\d+\.\d+),(\d+\.\d+\.\d+\.\d+),(\d+),(\d+)</regex>
  <order>rule_number,interface,action,direction,protocol_id,protocol,srcip,dstip,srcport,dstport</order>
</decoder>

<!-- Alternative decoder for ICMP (no ports) -->
<decoder name="pfsense-filterlog-icmp">
  <parent>pfsense-filterlog</parent>
  <regex type="pcre2">^(\d+),\d*,\d*,\w*,(\w+),\w+,(block|pass),(in|out),4,\w*,\w*,\d+,\d+,\d+,\w*,1,icmp,\d+,(\d+\.\d+\.\d+\.\d+),(\d+\.\d+\.\d+\.\d+)</regex>
  <order>rule_number,interface,action,direction,srcip,dstip</order>
</decoder>

<!-- IPv6 decoder -->
<decoder name="pfsense-filterlog-ipv6">
  <parent>pfsense-filterlog</parent>
  <regex type="pcre2">^(\d+),\d*,\d*,\w*,(\w+),\w+,(block|pass),(in|out),6,\w*,\d+,\w+,\d+,(\w+),\d+,([a-fA-F0-9:]+),([a-fA-F0-9:]+),(\d+),(\d+)</regex>
  <order>rule_number,interface,action,direction,protocol,srcip,dstip,srcport,dstport</order>
</decoder>

<!-- Simple fallback decoder for basic field extraction -->
<decoder name="pfsense-filterlog-simple">
  <parent>pfsense-filterlog</parent>
  <regex type="pcre2">(block|pass).+?(\d+\.\d+\.\d+\.\d+).+?(\d+\.\d+\.\d+\.\d+)</regex>
  <order>action,srcip,dstip</order>
</decoder>
